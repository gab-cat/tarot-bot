<!-- 51ae26e8-e49e-44eb-9863-471b011d1dbb d108b2d0-05cc-4f28-aa92-a0466663675b -->
# Xendit One‑Time Upgrade Integration

## Scope

- One‑time purchases only: Mystic (₱49) and Oracle (₱99)
- Create checkout links (Xendit Invoices/Payment Links) and send via Messenger
- Verify webhooks; on payment success, set `users.userType` to `"mystic"` or `"oracle"`
- Store payment records for idempotency/audit

## Files to Update

- `convex/schema.ts`: Add `payments` table
- `convex/http.ts`: Add `POST /xendit/checkout` and `POST /xendit/webhook`
- `convex/users.ts`: Add `upgradeUserType` internal mutation
- `convex/facebookApi.ts`: Add helper to send upgrade CTA and handle quick replies for Mystic/Oracle purchase
- `README.md`: Add environment variables and Xendit setup steps

## Data Model

Add `payments` table (Convex):

- `externalId: string` (Xendit invoice external_id)
- `invoiceId?: string` (Xendit invoice id)
- `messengerId: string`
- `plan: "mystic" | "oracle"`
- `amount: number` (PHP units; see note below)
- `currency: "PHP"`
- `status: "PENDING" | "PAID" | "EXPIRED" | "FAILED"`
- `invoiceUrl?: string`
- `createdAt: number`
- `paidAt?: number`
- Index: `by_external_id`

Note: Xendit amount units vary by currency. We will implement a helper and confirm against docs in code comments; for PHP, plan to treat as decimal pesos (e.g., 49 not 4900), and gate behind a converter.

## Environment Variables

Add to `.env` (and Convex dashboard):

- `XENDIT_SECRET_KEY=...` (Basic auth)
- `XENDIT_CALLBACK_TOKEN=...` (for `x-callback-token` header validation)
- `APP_BASE_URL=https://<your-deployment>.convex.cloud` (used for redirects)

## Endpoints

1) `POST /xendit/checkout`

- Body: `{ messengerId: string, plan: "mystic" | "oracle" }`
- Lookup/create user; derive `amount` by plan (`49` or `99` PHP)
- Compose `external_id`: `tb-{plan}-{messengerId}-{timestamp}`
- Create invoice via Xendit `POST /v2/invoices` with:
- `external_id`, `amount`, `currency: "PHP"`, `description`
- `success_redirect_url`, `failure_redirect_url` under `APP_BASE_URL`
- Optional `customer` fields if available
- Persist a `payments` row (PENDING)
- Return `{ invoiceUrl }` and also send a Messenger message with a button linking to the invoice URL

2) `POST /xendit/webhook`

- Validate `x-callback-token === XENDIT_CALLBACK_TOKEN` (401 if mismatch)
- Parse event; when `status: PAID` (or `"paid"` depending on payload), upsert payment by `external_id`:
- Set `status: PAID`, `paidAt`, `invoiceId`
- Idempotency: if already PAID, no-op
- Derive `messengerId` and `plan` from stored payment row (not from webhook body)
- Call internal mutation to update user: `users.userType = plan`, `isSubscribed = true`
- Optionally send confirmation via Messenger: “You’re upgraded to Mystic/Oracle. Enjoy!”
- Respond 200

## Messenger Flow

- Add a CTA command/quick replies when the user hits upgrade intent or on specific triggers:
- “Upgrade to Mystic (₱49)”, “Upgrade to Oracle (₱99)”
- On click, call `POST /xendit/checkout` then reply with the invoice URL

## Implementation Notes

- Use Convex `httpRouter` for both endpoints (similar to existing `/webhook` for FB)
- Use `fetch` with Basic Auth (`Authorization: Basic base64(secret_key:)`) for Xendit API
- Amount helper: `phpToXenditAmount(49)` returns the correct number per currency handling (centralize for future update if docs confirm minor units)
- Robust error handling with clear logs; never throw from webhook unless validation fails
- Security: Only trust upgrade on webhook, not on redirect URLs

## Xendit Dashboard Steps

1. API Keys

- Go to Dashboard → Settings → API Keys
- Create/Copy Secret API Key (Test for now)

2. Callback/Webhooks

- Dashboard → Settings → Callbacks (or API & Webhooks)
- Set `Invoice` callback URL to `https://<your-deployment>.convex.cloud/xendit/webhook`
- Set/Copy `Callback Token` and put it in `XENDIT_CALLBACK_TOKEN`

3. Payment Methods

- Enable payment methods suitable for PH (Cards, GCash, GrabPay, etc.)

4. Currencies

- Ensure PHP is enabled on your account

5. Test Mode

- Keep in Test; use test cards/GCash sandbox per Xendit docs

6. Go Live

- Switch to Live, rotate keys if needed, update Convex env vars, re-test

## Minimal Code Sketches (for reference)

- Create invoice request headers: `Authorization: Basic base64(XENDIT_SECRET_KEY + ":")`
- Webhook validation: `request.headers.get("x-callback-token")`
- Success statuses to consider: `paid` or `SETTLED` depending on object; map to `PAID`

## Risks / Open Points

- Amount units for PHP: confirm at implementation time; helper isolates impact
- Webhook payload shape changes: guard against unknown fields; rely on stored `external_id`
- Race conditions: If invoice paid after user navigates away, rely on webhook to finalize

### To-dos

- [ ] Add Convex `payments` table with indexes and types
- [ ] Add Xendit env vars and APP_BASE_URL to README and .env.example
- [ ] Create `POST /xendit/checkout` to create invoice and persist row
- [ ] Create `POST /xendit/webhook` to verify token and process paid
- [ ] Add internal mutation to set userType and isSubscribed
- [ ] Wire Messenger quick replies/buttons to trigger checkout and link
- [ ] Test flow in Test Mode; verify role upgrades and idempotency