<!-- 10cc81e8-4216-4ead-9127-c3b1643b471d fcd97131-e3a9-4ada-afca-6490b48682a2 -->
# Daily Reading Notification System

## Overview

Implement a notification system that sends users a mystical greeting at midnight when their daily readings reset, but only if they've used all their daily readings. Notifications will use stylized Unicode fonts and will be automatically canceled if the user gets a reading before midnight.

## Implementation Steps

### 1. Update Database Schema

**File**: `convex/schema.ts`

Add field to the `users` table to track scheduled notifications:

- `scheduledNotificationId`: `v.optional(v.id("_scheduled_functions"))`

### 2. Create Notification Module

**File**: `convex/notifications.ts` (new file)

Create functions for:

- `sendDailyReadingAvailableNotification` (internalMutation): Sends the notification message via Facebook Messenger with mystical greeting + styled fonts
- `scheduleReadingAvailableNotification` (internalMutation): Schedules notification for next midnight and stores job ID
- `cancelScheduledNotification` (internalMutation): Cancels pending notification if it exists

Include array of mystical greeting messages like:

- "The cosmic veil lifts once more..."
- "The cards awaken with the new dawn..."
- "Your mystical journey continues today..."

Use `toBoldFont()` from `constants.ts` for styling.

### 3. Integrate with Reading Creation

**File**: `convex/readings.ts`

Modify `createReading` mutation:

- After successfully creating a reading, check if user has reached their daily limit
- If limit reached (1 for free, 5 for mystic/pro), call internal function to schedule notification
- If limit not reached, cancel any existing scheduled notification

### 4. Handle Notification Cancellation

**File**: `convex/users.ts`

Update relevant functions to cancel notifications when:

- User gets a new reading before midnight (already handled in readings.ts)
- User upgrades their subscription tier (update `upgradeUserType`)

### 5. Calculate Next Midnight

**Utility**: In `notifications.ts`

Create helper function `getNextMidnightTimestamp()`:

- Get current date
- Calculate start of next day (midnight)
- Return timestamp in milliseconds
- Maintain consistency with existing date handling in `canReadToday`

### 6. Send Notification via Facebook

**Integration**: In `notifications.ts`

Use existing Facebook API pattern from `facebookApi.ts`:

- Build message with stylized fonts
- Include quick reply buttons: "ðŸ”® Start My Reading"
- Send via Facebook Messenger Send API
- Clear `scheduledNotificationId` after sending

## Key Files Modified

- `convex/schema.ts` - Add notification tracking field
- `convex/notifications.ts` - New module for notification logic
- `convex/readings.ts` - Schedule notifications after reading creation
- `convex/users.ts` - Cancel notifications on user upgrades

## Edge Cases Handled

- Oracle/Pro+ users (unlimited readings) won't receive notifications
- Multiple readings at limit: notification is rescheduled, not duplicated
- User reads before midnight: notification is canceled automatically
- Failed notification sends: logged but won't crash the system

### To-dos

- [ ] Add scheduledNotificationId field to users table in schema.ts
- [ ] Create notifications.ts with notification scheduling, sending, and cancellation functions
- [ ] Update createReading in readings.ts to schedule notifications when daily limit is reached
- [ ] Update user functions to cancel notifications when user upgrades or gets new reading
- [ ] Verify notification scheduling, cancellation, and message formatting work correctly